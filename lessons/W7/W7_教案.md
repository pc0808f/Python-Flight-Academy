# W7：旋轉控制（Yaw）與組合動作

## 教學目標
1. 理解無人機旋轉（Yaw）的概念
2. 掌握原地旋轉與方向控制
3. 學習組合多個飛行動作
4. 理解浮點數精確度問題

## 學習重點
- **旋轉控制**：順時針/逆時針旋轉
- **組合動作**：連續執行多個指令
- **浮點數精確度**：角度計算的精確度
- **空間座標系**：理解機體座標與世界座標

---

## 150 分鐘課程設計

### 【第一節】旋轉控制基礎（50 分鐘）

#### 1. 課程引入（10 分鐘）
**問題引導**：
- 「如果無人機只能前後左右移動，想要改變朝向怎麼辦？」
- 「飛機、汽車是怎麼轉彎的？」

**實際演示**：
- 使用手勢或模型，展示原地旋轉 vs 轉彎移動的差異
- 展示無人機的 Yaw（偏航）、Pitch（俯仰）、Roll（翻滾）三軸

#### 2. 旋轉指令講解（15 分鐘）

**基本語法**：
```python
# 在 Webots 中控制馬達差速實現旋轉
m1_motor.setVelocity(speed)   # 左前（逆時針）
m2_motor.setVelocity(-speed)  # 右前（順時針）
m3_motor.setVelocity(-speed)  # 左後（順時針）
m4_motor.setVelocity(speed)   # 右後（逆時針）
```

**旋轉方向判斷**：
- 正值：逆時針旋轉
- 負值：順時針旋轉
- 時間控制旋轉角度

**重要概念**：
- 旋轉速度 ≠ 移動速度
- 旋轉時需保持高度穩定
- 小角度旋轉比大角度精確

#### 3. 示範程式 01（10 分鐘）
**檔案**：`examples/W7/01_basic_rotation.py`

**教學要點**：
1. 起飛到穩定高度
2. 原地旋轉 90 度（順時針）
3. 停頓觀察
4. 再旋轉 90 度（逆時針回正）
5. 降落

**除錯提示**：
- 旋轉時間太短/太長會導致角度不準
- 需要實驗找出最佳參數

#### 4. 學生實作（15 分鐘）
**任務**：修改範例 01
- 基礎：讓無人機原地旋轉 360 度
- 進階：旋轉兩圈後回到原始朝向

**巡視重點**：
- 檢查學生是否理解時間與角度的關係
- 提醒旋轉後需要短暫停頓穩定

---

### 【第二節】浮點數精確度與組合動作（50 分鐘）

#### 1. 浮點數精確度問題（15 分鐘）

**實驗演示**：
```python
# 在 Python 中執行
angle = 0.1 + 0.1 + 0.1
print(angle)              # 0.30000000000000004
print(angle == 0.3)       # False
```

**為什麼重要？**
- 旋轉角度累積誤差
- 飛行距離計算偏差
- 條件判斷可能出錯

**解決方法**：
```python
# 方法 1：使用整數計算
angle_int = 30  # 以整數度數表示
time = angle_int / 90 * base_time

# 方法 2：四捨五入比較
if round(angle, 2) == 0.3:
    pass

# 方法 3：容差範圍判斷
if abs(angle - 0.3) < 0.0001:
    pass
```

#### 2. 示範程式 02（10 分鐘）
**檔案**：`examples/W7/02_float_precision.py`

**實驗內容**：
- 連續 10 次增加 0.1，觀察累積誤差
- 使用 round() 函數修正
- 比較整數運算 vs 浮點數運算

#### 3. 組合動作設計（10 分鐘）

**動作序列化**：
```python
def move_and_turn(distance, angle):
    """前進後旋轉"""
    move_forward(distance)
    time.sleep(0.5)  # 穩定停頓
    rotate(angle)
    time.sleep(0.5)  # 穩定停頓
```

**設計原則**：
1. 每個動作之間要有停頓
2. 複雜動作拆解成小步驟
3. 使用函數封裝常用組合

#### 4. 示範程式 03（15 分鐘）
**檔案**：`examples/W7/03_combined_actions.py`

**飛行任務**：
- 起飛 → 前進 1m → 右轉 90° → 前進 1m → 降落
- 展示動作序列的邏輯

**學生討論**：
- 「如果想飛出一個正方形，需要重複幾次這個組合？」
- 引導學生思考程式碼的可重複性（為 W8 鋪路）

---

### 【第三節】L 形路徑實作挑戰（50 分鐘）

#### 1. 路徑規劃講解（10 分鐘）

**L 形路徑分析**：
```
起點 →→→→ A 點
         ↓
         ↓
         ↓
         B 點
```

**步驟拆解**：
1. 起飛到固定高度
2. 前進 1.5 公尺（水平段）
3. 原地右轉 90 度
4. 前進 1.0 公尺（垂直段）
5. 降落

**座標系統說明**：
- 無人機的「前方」隨旋轉改變
- 需要理解相對方向 vs 絕對方向

#### 2. 示範程式 04（10 分鐘）
**檔案**：`examples/W7/04_L_shape_path.py`

**程式結構**：
```python
# 起飛
takeoff(height=1.0)

# 水平段
move_forward(duration=1.5, velocity=55)
hover(0.5)

# 轉彎
rotate_right(90)
hover(0.5)

# 垂直段
move_forward(duration=1.0, velocity=55)
hover(0.5)

# 降落
land()
```

#### 3. 學生挑戰（25 分鐘）

**基礎任務**：
- 完成標準 L 形路徑（1.5m + 1.0m）

**進階任務 1**：
- 反向 L 形（先轉彎再直線）

**進階任務 2**：
- Z 形路徑（三段直線，兩次轉彎）

**超級挑戰**：
- 飛出自己名字的第一個字母（如「C」、「F」、「T」）

#### 4. 成果展示與討論（5 分鐘）
- 2-3 組展示成功的程式
- 討論遇到的困難（角度不準、停頓時間等）
- 預告下週正方形挑戰

---

## 範例程式說明

### 01_basic_rotation.py
- **目的**：理解基本旋轉控制
- **難度**：⭐
- **重點**：時間與角度的關係

### 02_float_precision.py
- **目的**：認識浮點數誤差問題
- **難度**：⭐⭐
- **重點**：round() 函數使用

### 03_combined_actions.py
- **目的**：學習組合多個動作
- **難度**：⭐⭐
- **重點**：動作序列、停頓時間

### 04_L_shape_path.py
- **目的**：完成 L 形飛行路徑
- **難度**：⭐⭐⭐
- **重點**：路徑規劃、方向控制

### 05_Z_shape_advanced.py
- **目的**：進階挑戰 Z 形路徑
- **難度**：⭐⭐⭐⭐
- **重點**：複雜路徑、角度累積

---

## 作業

### 基礎作業（必做）
1. 完成 L 形路徑飛行，錄影上傳
2. 回答問題：
   - 為什麼旋轉後需要停頓？
   - 浮點數 0.1 + 0.2 的結果是什麼？

### 進階作業（選做）
1. 設計一個「回」字形飛行路徑（正方形 + 內部小正方形）
2. 實驗不同旋轉速度，找出最精確的 90 度旋轉參數

### 創意挑戰（加分）
- 用無人機飛出你的英文名字縮寫（如 "J" 或 "T"）

---

## 教學提醒

### 常見問題
1. **旋轉角度不準確**
   - 原因：時間參數不正確
   - 解決：實驗調整旋轉時間

2. **旋轉時高度下降**
   - 原因：馬達速度設定不當
   - 解決：檢查四個馬達的速度配置

3. **連續動作不流暢**
   - 原因：缺少停頓時間
   - 解決：每個動作後加 0.3-0.5 秒延遲

### 安全注意事項
- Webots 模擬器中旋轉速度過快可能導致模型不穩
- 實機操作時，旋轉必須在安全高度進行（至少 0.5m）
- 快速旋轉可能造成姿態失控

### 教學建議
- 使用實體模型或手勢輔助解釋旋轉方向
- 讓學生先在紙上畫出飛行路徑，再寫程式
- 鼓勵學生互相觀摩彼此的飛行路徑設計

---

## 下週預告

**W8：幾何飛行挑戰 - 正方形路徑**
- 組合本週學到的旋轉與移動
- 體驗重複程式碼的冗贅感
- 引出「有沒有更簡潔的寫法？」為迴圈鋪路
